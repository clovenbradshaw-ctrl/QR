<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personal QR Code Maker</title>
    <link rel="icon" type="image/png" href="https://storage.googleapis.com/art_homelessness/1.png">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --primary: #E67E22;
            --primary-dark: #D35400;
            --accent: #2C5F6F;
            --accent-light: #3A7D92;
            --success: #27AE60;
            --danger: #E74C3C;
            --text-dark: #2C3E50;
            --text-medium: #546E7A;
            --text-light: #95A5A6;
            --bg-primary: #FFFFFF;
            --bg-secondary: #F8F9FA;
            --bg-accent: #FFF5EE;
            --border-light: #E0E6ED;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.06);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.08);
            --shadow-lg: 0 8px 24px rgba(0,0,0,0.12);
        }
        
        body.theme-dark {
            --primary: #E67E22;
            --accent: #52A7BF;
            --text-dark: #ECEFF1;
            --text-medium: #B0BEC5;
            --text-light: #78909C;
            --bg-primary: #1A1F2E;
            --bg-secondary: #252A3A;
            --bg-accent: #2D3748;
            --border-light: #3A4556;
        }
        
        /* Identity toggle */
        .identity-toggle-control {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 6px 14px;
            border-radius: 999px;
            border: 1px solid var(--border-light);
            background: var(--bg-primary);
            color: var(--text-medium);
            font-size: 0.8rem;
            cursor: pointer;
            transition: border-color 0.2s ease, background 0.2s ease, color 0.2s ease;
            box-shadow: var(--shadow-sm);
            user-select: none;
        }

        .identity-toggle-control input[type="checkbox"] {
            width: 18px;
            height: 18px;
            margin: 0;
            accent-color: #7B1FA2;
            flex-shrink: 0;
        }

        .identity-toggle-text {
            display: flex;
            flex-direction: column;
            line-height: 1.2;
        }

        .identity-toggle-title {
            font-weight: 600;
            color: var(--text-medium);
            letter-spacing: 0.2px;
        }

        .identity-toggle-control.active {
            border-color: #9C27B0;
            background: rgba(156, 39, 176, 0.08);
            color: #7B1FA2;
        }

        .identity-toggle-control.active .identity-toggle-title {
            color: #7B1FA2;
        }

        .identity-toggle-hint {
            font-size: 0.75rem;
            color: var(--text-light);
        }

        body.theme-dark .identity-toggle-control {
            background: rgba(156, 39, 176, 0.12);
            border-color: rgba(156, 39, 176, 0.4);
            box-shadow: none;
        }

        body.theme-dark .identity-toggle-control.active {
            background: rgba(156, 39, 176, 0.2);
        }

        body.theme-dark .identity-toggle-title,
        body.theme-dark .identity-toggle-hint {
            color: #CE93D8;
        }

        body.theme-dark .identity-toggle-control.active .identity-toggle-title {
            color: #F3E5F5;
        }

        body.theme-dark .identity-toggle-control.active .identity-toggle-hint {
            color: #E1BEE7;
        }
        
        body.theme-medical {
            --primary: #E74C3C;
            --accent: #C0392B;
            --bg-accent: #FFEBEE;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif;
            font-size: 16px;
            line-height: 1.6;
            background: var(--bg-secondary);
            color: var(--text-dark);
            transition: background 0.3s ease, color 0.3s ease;
        }
        
        /* Hero Section with Illustration */
        .hero {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            padding: 48px 24px;
            text-align: center;
            position: relative;
            overflow: hidden;
            display: flex;
            justify-content: center;
        }

        .hero::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -10%;
            width: 500px;
            height: 500px;
            background: rgba(255,255,255,0.05);
            border-radius: 50%;
        }

        .hero.has-data {
            background: linear-gradient(135deg, #fdfbfb 0%, #ebedee 100%);
            color: var(--text-dark);
        }

        .hero.has-data::before {
            opacity: 0;
        }

        .hero-content {
            max-width: 960px;
            width: 100%;
            margin: 0 auto;
            position: relative;
            z-index: 1;
        }

        .hero-details {
            display: flex;
            flex-direction: column;
            gap: 16px;
            align-items: center;
            text-align: center;
            color: white;
        }

        .hero-details h1 {
            font-size: 2.75rem;
            font-weight: 700;
            line-height: 1.2;
        }

        .hero-details p {
            font-size: 1.25rem;
            max-width: 720px;
            color: rgba(255,255,255,0.9);
        }

        .hero.has-data .hero-details {
            background: var(--bg-primary);
            color: var(--text-dark);
            text-align: left;
            align-items: flex-start;
            padding: 32px;
            border-radius: 20px;
            box-shadow: var(--shadow-lg);
            gap: 24px;
        }

        .hero.has-data .hero-details h1,
        .hero.has-data .hero-details p {
            color: var(--text-dark);
        }

        .hero-fields {
            width: 100%;
            display: none;
            gap: 16px;
            margin-top: 8px;
        }

        .hero.has-data .hero-fields {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        }

        .hero-field {
            background: var(--bg-secondary);
            border-radius: 14px;
            padding: 16px;
            box-shadow: var(--shadow-sm);
        }

        .hero-field-label {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-medium);
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        .hero-field-label span:first-child {
            font-size: 1.2rem;
        }

        .hero-field-value {
            font-size: 1.1rem;
            color: var(--text-dark);
            word-break: break-word;
        }

        .hero-field-value a {
            color: var(--primary);
        }

        body.theme-dark .hero.has-data {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
        }

        body.theme-dark .hero.has-data .hero-details {
            background: #111827;
            box-shadow: none;
        }

        body.theme-dark .hero-field {
            background: #0f172a;
        }

        body.theme-dark .hero-field-label {
            color: var(--text-light);
        }

        .brand-card {
            background: var(--bg-primary);
            border-radius: 16px;
            padding: 32px;
            margin-bottom: 32px;
            box-shadow: var(--shadow-sm);
            text-align: center;
        }

        .brand-title {
            font-size: 2rem;
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 12px;
        }

        .brand-subtitle {
            font-size: 1.05rem;
            color: var(--text-medium);
            max-width: 640px;
            margin: 0 auto;
        }

        body.theme-dark .brand-card {
            background: #1f2937;
            box-shadow: none;
        }

        body.theme-dark .brand-subtitle {
            color: var(--text-light);
        }

        .decoded-cta {
            margin-top: 24px;
            padding: 24px;
            border-radius: 16px;
            background: var(--bg-secondary);
            border: 2px dashed var(--border-light);
            text-align: center;
        }

        .decoded-cta h3 {
            font-size: 1.4rem;
            margin-bottom: 8px;
            color: var(--text-dark);
        }

        .decoded-cta p {
            color: var(--text-medium);
            margin-bottom: 16px;
        }

        .decoded-cta .btn {
            padding: 12px 28px;
        }

        body.theme-dark .decoded-cta {
            background: #1f2937;
            border-color: #334155;
        }
        
        .container {
            max-width: 900px;
            margin: -40px auto 40px;
            padding: 0 24px;
            position: relative;
            z-index: 2;
        }
        
        /* Progress Indicator */
        .progress-indicator {
            display: flex;
            justify-content: space-between;
            margin-bottom: 40px;
            background: var(--bg-primary);
            padding: 24px;
            border-radius: 16px;
            box-shadow: var(--shadow-md);
        }
        
        .progress-step {
            flex: 1;
            text-align: center;
            position: relative;
            padding: 0 12px;
        }
        
        .progress-step:not(:last-child)::after {
            content: '';
            position: absolute;
            top: 16px;
            right: -50%;
            width: 100%;
            height: 2px;
            background: var(--border-light);
            z-index: -1;
        }
        
        .progress-step.active::after {
            background: var(--primary);
        }
        
        .progress-dot {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--border-light);
            margin: 0 auto 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-light);
            transition: all 0.3s ease;
        }
        
        .progress-step.active .progress-dot {
            background: var(--primary);
            color: white;
            transform: scale(1.1);
        }
        
        .progress-step.complete .progress-dot {
            background: var(--success);
            color: white;
        }
        
        .progress-label {
            font-size: 0.85rem;
            color: var(--text-medium);
            font-weight: 500;
        }
        
        .progress-step.active .progress-label {
            color: var(--text-dark);
            font-weight: 600;
        }
        
        /* Card Style */
        .card {
            background: var(--bg-primary);
            border-radius: 16px;
            padding: 32px;
            margin-bottom: 24px;
            box-shadow: var(--shadow-sm);
            transition: box-shadow 0.3s ease;
        }
        
        .card:hover {
            box-shadow: var(--shadow-md);
        }
        
        .card-header {
            margin-bottom: 24px;
        }
        
        .card-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 8px;
        }
        
        .card-subtitle {
            font-size: 0.95rem;
            color: var(--text-medium);
        }
        
        /* Mode Selector */
        .mode-selector {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 24px;
        }
        
        .mode-btn {
            padding: 24px;
            border: 2px solid var(--border-light);
            background: var(--bg-primary);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
        }
        
        .mode-btn:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        
        .mode-btn.active {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }
        
        .mode-icon {
            font-size: 2.5rem;
        }
        
        .mode-label {
            font-size: 1.1rem;
            font-weight: 600;
        }
        
        /* Template Grid */
        .template-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }
        
        .template-card {
            padding: 24px;
            border: 2px solid var(--border-light);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
            background: var(--bg-primary);
        }
        
        .template-card:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        
        .template-card.selected {
            border-color: var(--success);
            background: var(--bg-accent);
            box-shadow: var(--shadow-md);
        }
        
        .template-icon {
            font-size: 3rem;
            margin-bottom: 12px;
        }
        
        .template-name {
            font-weight: 600;
            font-size: 1.1rem;
            margin-bottom: 8px;
            color: var(--text-dark);
        }
        
        .template-desc {
            font-size: 0.9rem;
            color: var(--text-medium);
        }
        
        /* Compression Toggle */
        .compression-toggle {
            display: grid;
            gap: 16px;
        }
        
        .compression-option {
            padding: 20px;
            border: 2px solid var(--border-light);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            background: var(--bg-primary);
        }
        
        .compression-option:hover {
            border-color: var(--primary);
        }
        
        .compression-option.selected {
            border-color: var(--success);
            background: var(--bg-accent);
        }
        
        .compression-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 8px;
        }
        
        .radio-circle {
            width: 20px;
            height: 20px;
            border: 2px solid var(--border-light);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: border-color 0.2s ease;
        }
        
        .compression-option.selected .radio-circle {
            border-color: var(--success);
        }
        
        .radio-inner {
            width: 10px;
            height: 10px;
            background: var(--success);
            border-radius: 50%;
            display: none;
        }
        
        .compression-option.selected .radio-inner {
            display: block;
        }
        
        .compression-title {
            font-weight: 600;
            font-size: 1.05rem;
            color: var(--text-dark);
        }
        
        .compression-desc {
            font-size: 0.9rem;
            color: var(--text-medium);
            margin-left: 32px;
        }
        
        /* Info Banner */
        .info-banner {
            background: #E3F2FD;
            border-left: 4px solid #2196F3;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            gap: 12px;
            align-items: start;
        }
        
        .info-banner-icon {
            font-size: 1.25rem;
            flex-shrink: 0;
        }
        
        .info-banner-content {
            flex: 1;
        }
        
        .info-banner strong {
            color: #1976D2;
        }
        
        /* Form Elements */
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 0.95rem;
            color: var(--text-dark);
        }
        
        input[type="text"],
        input[type="email"],
        input[type="tel"],
        input[type="url"],
        input[type="password"],
        select,
        textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--border-light);
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.2s ease;
            background: var(--bg-primary);
            color: var(--text-dark);
        }
        
        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: var(--primary);
        }
        
        /* Field List */
        .field-list {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        
        .field-item {
            padding: 20px;
            background: var(--bg-secondary);
            border-radius: 8px;
            border: 1px solid var(--border-light);
            transition: box-shadow 0.2s ease;
        }
        
        .field-item:hover {
            box-shadow: var(--shadow-sm);
        }
        
        .field-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .field-label {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
            font-size: 1rem;
        }
        
        .field-icon {
            font-size: 1.3rem;
        }
        
        .field-actions {
            display: flex;
            gap: 8px;
        }
        
        /* Buttons */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        
        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }
        
        .btn-secondary {
            background: var(--accent);
            color: white;
        }
        
        .btn-secondary:hover {
            background: var(--accent-light);
        }
        
        .btn-outline {
            background: transparent;
            border: 2px solid var(--border-light);
            color: var(--text-dark);
        }
        
        .btn-outline:hover {
            border-color: var(--primary);
            background: var(--bg-accent);
        }
        
        .btn-small {
            padding: 6px 12px;
            font-size: 0.85rem;
        }
        
        .btn-danger {
            background: var(--danger);
            color: white;
        }
        
        .btn-success {
            background: var(--success);
            color: white;
        }
        
        /* Privacy Toggle */
        .privacy-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 12px;
            padding: 12px;
            background: var(--bg-primary);
            border-radius: 6px;
        }
        
        .privacy-toggle input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        .privacy-toggle label {
            margin: 0;
            font-weight: normal;
            font-size: 0.9rem;
            cursor: pointer;
        }
        
        /* QR Output */
        .qr-output {
            text-align: center;
            padding: 40px;
        }
        
        .qr-output h3 {
            font-size: 1.75rem;
            margin-bottom: 24px;
            color: var(--text-dark);
        }
        
        #qrcode {
            display: inline-block;
            padding: 24px;
            background: white;
            border-radius: 12px;
            box-shadow: var(--shadow-lg);
        }
        
        .button-group {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin-top: 24px;
            flex-wrap: wrap;
        }
        
        /* Theme Selector */
        .theme-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 16px;
        }
        
        .theme-option {
            padding: 16px;
            border: 2px solid var(--border-light);
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s ease;
            background: var(--bg-primary);
        }
        
        .theme-option:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
        }
        
        .theme-option.selected {
            border-color: var(--success);
            background: var(--bg-accent);
        }
        
        .theme-preview {
            width: 100%;
            height: 50px;
            border-radius: 6px;
            margin-bottom: 12px;
        }
        
        .theme-name {
            font-weight: 600;
            font-size: 0.95rem;
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.6);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(4px);
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: var(--bg-primary);
            padding: 32px;
            border-radius: 16px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }
        
        .modal-header h3 {
            font-size: 1.5rem;
            color: var(--text-dark);
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 1.75rem;
            cursor: pointer;
            color: var(--text-medium);
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background 0.2s ease;
        }
        
        .modal-close:hover {
            background: var(--bg-secondary);
        }
        
        /* Field Picker */
        .field-picker {
            display: grid;
            gap: 12px;
        }
        
        .field-picker-item {
            padding: 16px;
            border: 2px solid var(--border-light);
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all 0.2s ease;
        }
        
        .field-picker-item:hover {
            border-color: var(--primary);
            background: var(--bg-secondary);
        }
        
        .field-picker-category {
            margin-top: 24px;
            margin-bottom: 12px;
        }
        
        .field-picker-category h4 {
            font-size: 1rem;
            color: var(--text-medium);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        /* Identity Options Banner */
        .identity-options-banner {
            background: #F3E5F5;
            border: 2px solid #9C27B0;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        .identity-options-banner input[type="checkbox"] {
            width: 24px;
            height: 24px;
            cursor: pointer;
        }
        
        .identity-options-text {
            flex: 1;
        }
        
        .identity-options-text strong {
            color: #7B1FA2;
            display: block;
            margin-bottom: 4px;
        }
        
        .identity-options-text span {
            font-size: 0.9rem;
            color: var(--text-medium);
        }
        
        /* Utilities */
        .hidden {
            display: none !important;
        }
        
        .text-center {
            text-align: center;
        }
        
        .mb-16 {
            margin-bottom: 16px;
        }
        
        .mb-24 {
            margin-bottom: 24px;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .hero-details h1 {
                font-size: 2.1rem;
            }

            .hero-details p {
                font-size: 1.05rem;
            }

            .hero.has-data .hero-details {
                padding: 24px;
            }

            .hero.has-data .hero-fields {
                grid-template-columns: 1fr;
            }

            .container {
                padding: 0 16px;
            }

            .card {
                padding: 24px 20px;
            }
            
            .card-header {
                flex-direction: column !important;
                align-items: flex-start !important;
            }
            
            .progress-indicator {
                flex-direction: column;
                gap: 16px;
            }
            
            .progress-step::after {
                display: none;
            }
            
            .template-grid,
            .theme-grid {
                grid-template-columns: 1fr;
            }
            
            .mode-selector {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body class="theme-modern">
    <!-- Hero Section -->
    <div class="hero" id="hero">
        <div class="hero-content">
            <div class="hero-details" id="heroDetails">
                <h1 id="heroTitle">Scan a QR to view shared details</h1>
                <p id="heroSubtitle">Use the camera scanner below or open a QR link to instantly load someone's saved information.</p>
                <div id="heroFields" class="hero-fields hidden"></div>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="brand-card">
            <h2 class="brand-title">Personal QR Code Maker</h2>
            <p class="brand-subtitle">Design a code that keeps your most important information ready to share ‚Äî from emergency contacts to social profiles ‚Äî and update it anytime.</p>
        </div>

        <!-- Mode Selector -->
        <div class="mode-selector">
            <button class="mode-btn active" data-mode="create">
                <span class="mode-icon">‚úèÔ∏è</span>
                <span class="mode-label">Make a QR</span>
            </button>
            <button class="mode-btn" data-mode="view">
                <span class="mode-icon">üëÅÔ∏è</span>
                <span class="mode-label">Scan a Code</span>
            </button>
        </div>

        <!-- Create Mode -->
        <div id="createMode">
            <!-- Progress Indicator -->
            <div class="progress-indicator">
                <div class="progress-step active" data-step="1">
                    <div class="progress-dot">1</div>
                    <div class="progress-label">Template</div>
                </div>
                <div class="progress-step" data-step="2">
                    <div class="progress-dot">2</div>
                    <div class="progress-label">Storage</div>
                </div>
                <div class="progress-step" data-step="3">
                    <div class="progress-dot">3</div>
                    <div class="progress-label">Information</div>
                </div>
                <div class="progress-step" data-step="4">
                    <div class="progress-dot">4</div>
                    <div class="progress-label">Style</div>
                </div>
                <div class="progress-step" data-step="5">
                    <div class="progress-dot">5</div>
                    <div class="progress-label">Create</div>
                </div>
            </div>

            <!-- Step 1: Template -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Choose a Template</h2>
                    <p class="card-subtitle">Select what type of information you want to share</p>
                </div>
                
                <div class="template-grid" id="templateSelector"></div>
            </div>

            <!-- Step 2: Storage -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Storage Type</h2>
                    <p class="card-subtitle">How much information do you want to include?</p>
                </div>
                
                <div class="info-banner">
                    <div class="info-banner-icon">üí°</div>
                    <div class="info-banner-content">
                        <strong>Recommendation:</strong> Use Smart Code for most situations. It stores 2-3√ó more information.
                    </div>
                </div>
                
                <div class="compression-toggle">
                    <div class="compression-option selected" data-mode="maximum">
                        <div class="compression-header">
                            <div class="radio-circle">
                                <div class="radio-inner"></div>
                            </div>
                            <div class="compression-title">Smart Code (Recommended)</div>
                        </div>
                        <div class="compression-desc">
                            Stores more information efficiently. Requires this website to read.
                        </div>
                    </div>
                    <div class="compression-option" data-mode="basic">
                        <div class="compression-header">
                            <div class="radio-circle">
                                <div class="radio-inner"></div>
                            </div>
                            <div class="compression-title">Simple Code</div>
                        </div>
                        <div class="compression-desc">
                            Works with any QR reader app, but stores less information.
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 3: Information -->
            <div class="card">
                <div class="card-header" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px;">
                    <div>
                        <h2 class="card-title" style="margin-bottom: 8px;">Add Your Information</h2>
                        <p class="card-subtitle" style="margin: 0;">Fill in the details you want to share</p>
                    </div>
                    <label class="identity-toggle-control" id="identityToggleControl">
                        <input type="checkbox" id="identityFieldsToggle">
                        <div class="identity-toggle-text">
                            <span class="identity-toggle-title">Identity fields</span>
                            <span class="identity-toggle-hint" id="identityToggleHint">Hidden (not included in QR).</span>
                        </div>
                    </label>
                </div>
                
                <div class="field-list" id="fieldList"></div>
                
                <div style="margin-top: 20px; text-align: center;">
                    <button class="btn btn-outline" id="addFieldBtn">
                        <span>‚ûï</span> Add More Info
                    </button>
                </div>
            </div>

            <!-- Step 4: Style -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Choose Style</h2>
                    <p class="card-subtitle">Pick a visual theme for your code</p>
                </div>
                <div class="theme-grid" id="themeSelector"></div>
            </div>

            <!-- Step 5: Create -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Create Your Code</h2>
                    <p class="card-subtitle">Generate and download your QR code</p>
                </div>
                
                <div class="text-center">
                    <button class="btn btn-primary" id="generateBtn" style="font-size: 1.2rem; padding: 16px 40px;">
                        Create My QR Code ‚Üí
                    </button>
                </div>
                
                <div id="qrOutput" class="hidden">
                    <div class="qr-output">
                        <h3>‚úÖ Your Code is Ready!</h3>
                        <div id="qrcode"></div>
                        <div class="button-group">
                            <button class="btn btn-success" id="downloadQR">
                                <span>üíæ</span> Save Image
                            </button>
                            <button class="btn btn-secondary" id="printQR">
                                <span>üñ®Ô∏è</span> Print
                            </button>
                        </div>
                        <div style="margin-top: 20px;">
                            <p id="dataSize" style="font-size: 0.95rem; color: var(--text-medium);"></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- View Mode -->
        <div id="viewMode" class="hidden">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Scan a Code</h2>
                    <p class="card-subtitle">Use your camera to scan a QR code</p>
                </div>
                
                <div id="scannerContainer" class="text-center">
                    <button class="btn btn-primary" id="startScanBtn">
                        <span>üì∑</span> Start Camera Scanner
                    </button>
                    <video id="videoElement" style="display: none; max-width: 100%; border-radius: 12px; margin-top: 20px;"></video>
                    <canvas id="canvasElement" style="display: none;"></canvas>
                    <p style="margin-top: 20px; color: var(--text-medium);">
                        Or paste a QR code URL in your browser to view it
                    </p>
                </div>
                <div id="decodedData"></div>
            </div>
        </div>
    </div>

    <!-- About & Security Section -->
    <div class="about-section" style="background: var(--bg-primary); padding: 48px 32px; border-radius: 16px; margin: 40px auto; box-shadow: var(--shadow-md); max-width: 1100px;">
        <div style="max-width: 800px; margin: 0 auto;">
            <div style="text-align: center; margin-bottom: 40px;">
                <h2 style="font-size: 2rem; color: var(--text-dark); margin-bottom: 16px;">üîí Your Privacy, Protected</h2>
                <p style="font-size: 1.1rem; color: var(--text-medium);">This tool is designed with your privacy as the top priority.</p>
            </div>

            <div style="display: grid; gap: 24px;">
                <!-- Security Feature 1 -->
                <div style="display: flex; gap: 20px; padding: 24px; background: var(--bg-secondary); border-radius: 12px; border-left: 4px solid var(--success);">
                    <div style="font-size: 2.5rem; flex-shrink: 0;">üíæ</div>
                    <div>
                        <h3 style="font-size: 1.25rem; color: var(--text-dark); margin-bottom: 8px; font-weight: 600;">Nothing Stored Online</h3>
                        <p style="color: var(--text-medium); line-height: 1.6;">
                            Your information never touches our servers. Everything is encoded directly into the QR code image on your device.
                            No databases, no cloud storage, no third parties. When you create a code, it exists only in your hands.
                        </p>
                    </div>
                </div>

                <!-- Security Feature 2 -->
                <div style="display: flex; gap: 20px; padding: 24px; background: var(--bg-secondary); border-radius: 12px; border-left: 4px solid var(--primary);">
                    <div style="font-size: 2.5rem; flex-shrink: 0;">üîê</div>
                    <div>
                        <h3 style="font-size: 1.25rem; color: var(--text-dark); margin-bottom: 8px; font-weight: 600;">Military-Grade Encryption</h3>
                        <p style="color: var(--text-medium); line-height: 1.6;">
                            When you password-protect fields, we use AES-256 encryption‚Äîthe same standard used by banks and governments.
                            Without your password, the protected information is mathematically impossible to decode. Not even we can access it.
                        </p>
                    </div>
                </div>

                <!-- Security Feature 3 -->
                <div style="display: flex; gap: 20px; padding: 24px; background: var(--bg-secondary); border-radius: 12px; border-left: 4px solid var(--accent);">
                    <div style="font-size: 2.5rem; flex-shrink: 0;">üì±</div>
                    <div>
                        <h3 style="font-size: 1.25rem; color: var(--text-dark); margin-bottom: 8px; font-weight: 600;">Works Completely Offline</h3>
                        <p style="color: var(--text-medium); line-height: 1.6;">
                            After loading this page once, you can use it without an internet connection. Save the page to your device and
                            generate codes anytime, anywhere‚Äîno tracking, no data collection, no internet required.
                        </p>
                    </div>
                </div>

                <!-- Security Feature 4 -->
                <div style="display: flex; gap: 20px; padding: 24px; background: var(--bg-secondary); border-radius: 12px; border-left: 4px solid #9C27B0;">
                    <div style="font-size: 2.5rem; flex-shrink: 0;">üëÅÔ∏è</div>
                    <div>
                        <h3 style="font-size: 1.25rem; color: var(--text-dark); margin-bottom: 8px; font-weight: 600;">You Control What's Shared</h3>
                        <p style="color: var(--text-medium); line-height: 1.6;">
                            Every field is optional. Share only what you're comfortable sharing. Use password protection for sensitive information
                            like medical data‚Äîit stays encrypted in the QR code until you enter your password to decrypt it.
                        </p>
                    </div>
                </div>
            </div>

            <!-- How It Works -->
            <div style="margin-top: 40px; padding: 32px; background: linear-gradient(135deg, rgba(230, 126, 34, 0.1) 0%, rgba(44, 95, 111, 0.1) 100%); border-radius: 12px;">
                <h3 style="font-size: 1.5rem; color: var(--text-dark); margin-bottom: 20px; text-align: center; font-weight: 600;">How It Works</h3>

                <div style="display: grid; gap: 16px; margin-top: 24px;">
                    <div style="display: flex; align-items: start; gap: 16px;">
                        <div style="background: var(--primary); color: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; flex-shrink: 0;">1</div>
                        <div>
                            <strong style="color: var(--text-dark);">You enter your information</strong>
                            <p style="color: var(--text-medium); margin-top: 4px;">Add the fields you want to share‚Äîname, contact info, medical alerts, social profiles, etc.</p>
                        </div>
                    </div>

                    <div style="display: flex; align-items: start; gap: 16px;">
                        <div style="background: var(--primary); color: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; flex-shrink: 0;">2</div>
                        <div>
                            <strong style="color: var(--text-dark);">Sensitive data gets encrypted</strong>
                            <p style="color: var(--text-medium); margin-top: 4px;">Fields you mark as protected are encrypted with your password using AES-256 encryption right in your browser.</p>
                        </div>
                    </div>

                    <div style="display: flex; align-items: start; gap: 16px;">
                        <div style="background: var(--primary); color: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; flex-shrink: 0;">3</div>
                        <div>
                            <strong style="color: var(--text-dark);">Everything is encoded into the QR code</strong>
                            <p style="color: var(--text-medium); margin-top: 4px;">All your information‚Äîpublic and encrypted‚Äîis compressed and embedded into the QR code pattern itself.</p>
                        </div>
                    </div>

                    <div style="display: flex; align-items: start; gap: 16px;">
                        <div style="background: var(--primary); color: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; flex-shrink: 0;">4</div>
                        <div>
                            <strong style="color: var(--text-dark);">You download and share the code</strong>
                            <p style="color: var(--text-medium); margin-top: 4px;">Save the QR code image. Print it, add it to ID cards, wear it on a bracelet‚Äîit's yours to use however you want.</p>
                        </div>
                    </div>

                    <div style="display: flex; align-items: start; gap: 16px;">
                        <div style="background: var(--primary); color: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; flex-shrink: 0;">5</div>
                        <div>
                            <strong style="color: var(--text-dark);">Others scan to see your info</strong>
                            <p style="color: var(--text-medium); margin-top: 4px;">Anyone can scan your code to see public information. Protected fields require them to enter your password to decrypt.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Use Cases -->
            <div style="margin-top: 40px;">
                <h3 style="font-size: 1.5rem; color: var(--text-dark); margin-bottom: 24px; text-align: center; font-weight: 600;">Perfect For</h3>

                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px;">
                    <div style="padding: 20px; background: var(--bg-secondary); border-radius: 8px; text-align: center;">
                        <div style="font-size: 2rem; margin-bottom: 8px;">üÜò</div>
                        <strong style="display: block; color: var(--text-dark); margin-bottom: 8px;">Emergency Medical Info</strong>
                        <p style="font-size: 0.9rem; color: var(--text-medium);">Blood type, allergies, medications‚Äîcritical info first responders need</p>
                    </div>

                    <div style="padding: 20px; background: var(--bg-secondary); border-radius: 8px; text-align: center;">
                        <div style="font-size: 2rem; margin-bottom: 8px;">üè†</div>
                        <strong style="display: block; color: var(--text-dark); margin-bottom: 8px;">Housing Services</strong>
                        <p style="font-size: 0.9rem; color: var(--text-medium);">Safe way to share contact info and needs with service providers</p>
                    </div>

                    <div style="padding: 20px; background: var(--bg-secondary); border-radius: 8px; text-align: center;">
                        <div style="font-size: 2rem; margin-bottom: 8px;">üëî</div>
                        <strong style="display: block; color: var(--text-dark); margin-bottom: 8px;">Professional Networking</strong>
                        <p style="font-size: 0.9rem; color: var(--text-medium);">Digital business cards that update without reprinting</p>
                    </div>

                    <div style="padding: 20px; background: var(--bg-secondary); border-radius: 8px; text-align: center;">
                        <div style="font-size: 2rem; margin-bottom: 8px;">üè≥Ô∏è‚Äç‚ößÔ∏è</div>
                        <strong style="display: block; color: var(--text-dark); margin-bottom: 8px;">Identity Expression</strong>
                        <p style="font-size: 0.9rem; color: var(--text-medium);">Share pronouns and preferred name on your terms</p>
                    </div>
                </div>
            </div>

            <!-- Technical Details (Collapsible) -->
            <details style="margin-top: 32px; padding: 24px; background: var(--bg-secondary); border-radius: 8px;">
                <summary style="cursor: pointer; font-weight: 600; color: var(--text-dark); font-size: 1.1rem; user-select: none;">
                    üî¨ Technical Security Details
                </summary>
                <div style="margin-top: 16px; color: var(--text-medium); line-height: 1.8;">
                    <p style="margin-bottom: 12px;"><strong>Encryption:</strong> AES-256-GCM with PBKDF2 key derivation (100,000 iterations)</p>
                    <p style="margin-bottom: 12px;"><strong>Data Storage:</strong> All data encoded in the QR code itself using base64 JSON compression</p>
                    <p style="margin-bottom: 12px;"><strong>Privacy:</strong> Zero server communication after page load. No analytics, no tracking, no cookies</p>
                    <p style="margin-bottom: 12px;"><strong>Open Source:</strong> Code is transparent and auditable. No hidden backdoors or data collection</p>
                    <p style="margin-bottom: 12px;"><strong>Browser Only:</strong> All encryption/decryption happens in your browser using Web Crypto API</p>
                    <p><strong>No Recovery:</strong> If you forget your password, encrypted data cannot be recovered. This is by design for your security.</p>
                </div>
            </details>

            <!-- Important Warning -->
            <div style="margin-top: 32px; padding: 20px; background: #FFF3E0; border-left: 4px solid #F57C00; border-radius: 8px;">
                <div style="display: flex; gap: 12px; align-items: start;">
                    <div style="font-size: 1.5rem;">‚ö†Ô∏è</div>
                    <div>
                        <strong style="color: #E65100; display: block; margin-bottom: 8px;">Important Security Reminders</strong>
                        <ul style="color: #E65100; margin-left: 20px; line-height: 1.8;">
                            <li>Anyone who scans your QR code can see unprotected information</li>
                            <li>Use password protection for sensitive data like medical information</li>
                            <li>Choose a strong password you'll remember‚Äîthere's no recovery option</li>
                            <li>Physical security matters: treat the QR code like you would an ID card</li>
                            <li>You can always create a new QR code if you want to change information</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- FAQ Teaser -->
            <div style="margin-top: 32px; text-align: center; padding: 24px; background: var(--bg-accent); border-radius: 8px;">
                <h3 style="color: var(--text-dark); font-size: 1.25rem; margin-bottom: 8px;">Have Questions?</h3>
                <p style="color: var(--text-medium); margin-bottom: 16px;">We're here to help you understand how this works.</p>
                <button onclick="document.getElementById('faqSection').scrollIntoView({behavior: 'smooth'})"
                        style="background: var(--primary); color: white; border: none; padding: 12px 24px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 1rem;">
                    View Frequently Asked Questions ‚Üí
                </button>
            </div>
        </div>
    </div>

    <!-- FAQ Section -->
    <div id="faqSection" class="faq-section" style="background: var(--bg-secondary); padding: 48px 32px; border-radius: 16px; margin: 24px auto 60px; max-width: 1100px;">
        <div style="max-width: 800px; margin: 0 auto;">
            <h2 style="font-size: 2rem; color: var(--text-dark); margin-bottom: 32px; text-align: center;">Frequently Asked Questions</h2>

            <div style="display: grid; gap: 16px;">
                <!-- FAQ Item -->
                <details style="background: var(--bg-primary); padding: 20px; border-radius: 8px; border: 1px solid var(--border-light);">
                    <summary style="cursor: pointer; font-weight: 600; color: var(--text-dark); font-size: 1.05rem; user-select: none;">
                        Can you recover my password if I forget it?
                    </summary>
                    <p style="margin-top: 12px; color: var(--text-medium); line-height: 1.6;">
                        No. This is actually a security feature, not a bug. Because we never see your password or encrypted data, there's no "forgot password" option.
                        If you forget your password, the encrypted information cannot be recovered by anyone‚Äînot even us. This ensures your sensitive data is truly secure.
                    </p>
                </details>

                <details style="background: var(--bg-primary); padding: 20px; border-radius: 8px; border: 1px solid var(--border-light);">
                    <summary style="cursor: pointer; font-weight: 600; color: var(--text-dark); font-size: 1.05rem; user-select: none;">
                        What happens if someone takes a photo of my QR code?
                    </summary>
                    <p style="margin-top: 12px; color: var(--text-medium); line-height: 1.6;">
                        They can scan it to see any unprotected information you included. That's why we recommend password-protecting sensitive fields like medical data.
                        Public information (like your name and phone number) will be visible to anyone who scans the code, just like it would be on a business card.
                    </p>
                </details>

                <details style="background: var(--bg-primary); padding: 20px; border-radius: 8px; border: 1px solid var(--border-light);">
                    <summary style="cursor: pointer; font-weight: 600; color: var(--text-dark); font-size: 1.05rem; user-select: none;">
                        Do I need this website to scan the QR code?
                    </summary>
                    <p style="margin-top: 12px; color: var(--text-medium); line-height: 1.6;">
                        For "Maximum Storage" codes, yes‚Äîyou'll need to scan them using this website to decrypt the compressed data.
                        For "Basic Storage" codes, any standard QR reader app will work. We recommend Maximum Storage because it can hold 2-3√ó more information.
                    </p>
                </details>

                <details style="background: var(--bg-primary); padding: 20px; border-radius: 8px; border: 1px solid var(--border-light);">
                    <summary style="cursor: pointer; font-weight: 600; color: var(--text-dark); font-size: 1.05rem; user-select: none;">
                        Can I update my information after creating the QR code?
                    </summary>
                    <p style="margin-top: 12px; color: var(--text-medium); line-height: 1.6;">
                        No‚Äîthe QR code is a static image with information permanently embedded. If you need to update your information,
                        you'll need to create a new QR code. The advantage is that no one can change your information remotely or track when it's scanned.
                    </p>
                </details>

                <details style="background: var(--bg-primary); padding: 20px; border-radius: 8px; border: 1px solid var(--border-light);">
                    <summary style="cursor: pointer; font-weight: 600; color: var(--text-dark); font-size: 1.05rem; user-select: none;">
                        Is my information sent to your servers?
                    </summary>
                    <p style="margin-top: 12px; color: var(--text-medium); line-height: 1.6;">
                        Absolutely not. Everything happens in your browser. Your information is encoded directly into the QR code image on your device.
                        We never see it, we don't store it, and we can't access it. You can even use this tool completely offline after the page loads once.
                    </p>
                </details>

                <details style="background: var(--bg-primary); padding: 20px; border-radius: 8px; border: 1px solid var(--border-light);">
                    <summary style="cursor: pointer; font-weight: 600; color: var(--text-dark); font-size: 1.05rem; user-select: none;">
                        How much information can I store in a QR code?
                    </summary>
                    <p style="margin-top: 12px; color: var(--text-medium); line-height: 1.6;">
                        With Maximum Storage mode, you can typically store 8-12 fields of information (name, contact details, medical info, etc.).
                        Basic Storage mode holds less but works with any QR reader. The exact amount depends on how much text is in each field.
                    </p>
                </details>

                <details style="background: var(--bg-primary); padding: 20px; border-radius: 8px; border: 1px solid var(--border-light);">
                    <summary style="cursor: pointer; font-weight: 600; color: var(--text-dark); font-size: 1.05rem; user-select: none;">
                        Can I use this for my organization or multiple people?
                    </summary>
                    <p style="margin-top: 12px; color: var(--text-medium); line-height: 1.6;">
                        Absolutely! This tool is free to use for any purpose. Create as many QR codes as you need.
                        You can save the webpage and distribute it to your organization so everyone can create their own codes offline.
                    </p>
                </details>

                <details style="background: var(--bg-primary); padding: 20px; border-radius: 8px; border: 1px solid var(--border-light);">
                    <summary style="cursor: pointer; font-weight: 600; color: var(--text-dark); font-size: 1.05rem; user-select: none;">
                        What's the difference between the identity options?
                    </summary>
                    <p style="margin-top: 12px; color: var(--text-medium); line-height: 1.6;">
                        Identity options (preferred name, pronouns, gender identity) are hidden by default to respect privacy.
                        You must explicitly check "Show identity options" to add these fields. This ensures no one is forced to share identity information they're not comfortable sharing.
                    </p>
                </details>
            </div>
        </div>
    </div>

    <!-- Field Picker Modal -->
    <div id="fieldPickerModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add Information</h3>
                <button class="modal-close" onclick="closeFieldPicker()">√ó</button>
            </div>
            <div class="field-picker" id="fieldPickerList"></div>
        </div>
    </div>

    <!-- Password Modal -->
    <div id="passwordModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üîí Set Password</h3>
                <button class="modal-close" onclick="closePasswordModal()">√ó</button>
            </div>
            <div class="info-banner" style="margin-bottom: 24px;">
                <div class="info-banner-icon">‚ÑπÔ∏è</div>
                <div class="info-banner-content">
                    This password will protect all marked fields. You'll need it to view protected information.
                </div>
            </div>
            <div class="form-group">
                <label for="passwordInput">Enter Password</label>
                <input type="password" id="passwordInput" placeholder="Choose a strong password">
            </div>
            <div class="form-group">
                <label for="passwordConfirm">Confirm Password</label>
                <input type="password" id="passwordConfirm" placeholder="Re-enter password">
            </div>
            <div id="passwordStrength"></div>
            <div class="button-group" style="margin-top: 24px;">
                <button class="btn btn-outline" onclick="closePasswordModal()">Cancel</button>
                <button class="btn btn-primary" id="setPasswordBtn">Set Password</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
    <script>
        // Field Dictionary (same as original)
        const FIELD_DICTIONARY = {
            1: { key: "name", label: "Full Name", type: "text", icon: "üë§", category: "Basic" },
            403: { key: "preferredName", label: "Preferred Name", type: "text", icon: "‚ú®", category: "Identity" },
            51: { key: "phone", label: "Phone Number", type: "tel", icon: "üìû", category: "Contact" },
            52: { key: "mobile", label: "Mobile Number", type: "tel", icon: "üì±", category: "Contact" },
            76: { key: "email", label: "Email Address", type: "email", icon: "‚úâÔ∏è", category: "Contact" },
            103: { key: "instagram", label: "Instagram", type: "text", icon: "üì∑", category: "Social" },
            104: { key: "linkedin", label: "LinkedIn", type: "text", icon: "üíº", category: "Social" },
            110: { key: "website", label: "Website", type: "url", icon: "üåê", category: "Social" },
            201: { key: "jobTitle", label: "Job Title", type: "text", icon: "üíº", category: "Work" },
            202: { key: "company", label: "Company", type: "text", icon: "üè¢", category: "Work" },
            251: { key: "bloodType", label: "Blood Type", type: "select", icon: "ü©∏", category: "Medical", 
                   options: ["A+", "A-", "B+", "B-", "AB+", "AB-", "O+", "O-"] },
            252: { key: "allergies", label: "Allergies", type: "text", icon: "‚ö†Ô∏è", category: "Medical" },
            253: { key: "medications", label: "Medications", type: "medication", icon: "üíä", category: "Medical" },
            255: { key: "emergencyContact", label: "Emergency Contact", type: "text", icon: "üö®", category: "Medical" },
            256: { key: "emergencyPhone", label: "Emergency Phone", type: "tel", icon: "üìû", category: "Medical" },
            326: { key: "address", label: "Address", type: "text", icon: "üìç", category: "Location" },
            401: { key: "pronouns", label: "Pronouns", type: "select", icon: "üí¨", category: "Identity",
                   options: ["he/him", "she/her", "they/them", "he/they", "she/they", "ze/zir", "Other", "Prefer not to say"] },
            402: { key: "genderIdentity", label: "Gender Identity", type: "select", icon: "üè≥Ô∏è‚Äç‚ößÔ∏è", category: "Identity",
                   options: ["Man", "Woman", "Non-binary", "Genderqueer", "Genderfluid", "Agender", "Two-Spirit", "Transgender man", "Transgender woman", "Other", "Prefer not to say"] },
        };

        const TEMPLATES = {
            business: {
                name: "Business Card",
                icon: "üíº",
                description: "Professional contact info",
                defaultFields: [1, 201, 202, 52, 76, 104]
            },
            emergency: {
                name: "Medical Emergency",
                icon: "üö®",
                description: "Critical medical information",
                defaultFields: [1, 251, 252, 253, 255, 256]
            },
            social: {
                name: "Social Profile",
                icon: "üì±",
                description: "Social media profiles",
                defaultFields: [1, 76, 103, 104, 110]
            },
            custom: {
                name: "Custom",
                icon: "‚öôÔ∏è",
                description: "Start from scratch",
                defaultFields: []
            }
        };

        const THEMES = {
            modern: { name: "Clean", color: "#E67E22", class: "theme-modern" },
            medical: { name: "Medical", color: "#E74C3C", class: "theme-medical" },
            dark: { name: "Dark", color: "#1A1F2E", class: "theme-dark" }
        };

        const state = {
            selectedTemplate: 'business',
            fields: [],
            selectedTheme: 'modern',
            compressed: true,
            nextFieldId: 1,
            medications: {},
            protectionPassword: null,
            hasProtectedFields: false,
            showIdentityFields: false,
            hiddenIdentityFields: [],
            currentStep: 1
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            initializeTemplateSelector();
            initializeThemeSelector();
            initializeEventListeners();
            loadDefaultTemplate();
            enforceIdentityFieldVisibility();
            setHeroDefault();
            checkURLForData();
            updateProgress();
        });

        function initializeTemplateSelector() {
            const selector = document.getElementById('templateSelector');
            selector.innerHTML = '';
            Object.entries(TEMPLATES).forEach(([key, template]) => {
                const card = document.createElement('div');
                card.className = 'template-card';
                card.dataset.template = key;
                if (key === state.selectedTemplate) card.classList.add('selected');
                card.innerHTML = `
                    <div class="template-icon">${template.icon}</div>
                    <div class="template-name">${template.name}</div>
                    <div class="template-desc">${template.description}</div>
                `;
                card.addEventListener('click', () => selectTemplate(key));
                selector.appendChild(card);
            });
        }

        function initializeThemeSelector() {
            const selector = document.getElementById('themeSelector');
            selector.innerHTML = '';
            Object.entries(THEMES).forEach(([key, theme]) => {
                const option = document.createElement('div');
                option.className = 'theme-option';
                option.dataset.theme = key;
                if (key === state.selectedTheme) option.classList.add('selected');
                option.innerHTML = `
                    <div class="theme-preview" style="background: ${theme.color};"></div>
                    <div class="theme-name">${theme.name}</div>
                `;
                option.addEventListener('click', () => selectTheme(key));
                selector.appendChild(option);
            });
        }

        function initializeEventListeners() {
            // Mode switching
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
                    e.currentTarget.classList.add('active');
                    const mode = e.currentTarget.dataset.mode;
                    document.getElementById('createMode').classList.toggle('hidden', mode !== 'create');
                    document.getElementById('viewMode').classList.toggle('hidden', mode !== 'view');
                });
            });

            // Compression options
            document.querySelectorAll('.compression-option').forEach(option => {
                option.addEventListener('click', (e) => {
                    document.querySelectorAll('.compression-option').forEach(o => o.classList.remove('selected'));
                    e.currentTarget.classList.add('selected');
                    state.compressed = e.currentTarget.dataset.mode === 'maximum';
                    updateProgress();
                });
            });

            // Buttons
            document.getElementById('addFieldBtn').addEventListener('click', showFieldPicker);
            document.getElementById('generateBtn').addEventListener('click', generateQR);
            document.getElementById('downloadQR').addEventListener('click', downloadQR);
            document.getElementById('printQR').addEventListener('click', () => window.print());
            document.getElementById('startScanBtn').addEventListener('click', startScanner);
            
            // Password modal
            document.getElementById('setPasswordBtn').addEventListener('click', validateAndSetPassword);
            document.getElementById('passwordInput').addEventListener('input', updatePasswordStrength);
            document.getElementById('passwordConfirm').addEventListener('input', updatePasswordStrength);
            
            // Identity fields toggle
            const identityToggle = document.getElementById('identityFieldsToggle');

            if (identityToggle) {
                // Check for debug mode (URL parameter)
                const urlParams = new URLSearchParams(window.location.search);
                if (urlParams.get('reset') === 'true') {
                    localStorage.removeItem('qr-show-identity-fields');
                    console.log('üîÑ Reset: Cleared identity toggle preference');
                }

                // Load identity fields preference - default to FALSE (unchecked)
                const savedPreference = localStorage.getItem('qr-show-identity-fields');
                console.log('üíæ Saved preference:', savedPreference);

                if (savedPreference !== null) {
                    state.showIdentityFields = savedPreference === 'true';
                } else {
                    state.showIdentityFields = false; // Default to unchecked
                }

                // Set checkbox to match state
                identityToggle.checked = state.showIdentityFields;
                console.log('üèÅ Initial identity toggle state:', state.showIdentityFields, 'checkbox:', identityToggle.checked);

                // Add change listener
                identityToggle.addEventListener('change', (e) => {
                    console.log('üîÑ Identity toggle changed:', e.target.checked);
                    state.showIdentityFields = e.target.checked;
                    localStorage.setItem('qr-show-identity-fields', e.target.checked ? 'true' : 'false');
                    enforceIdentityFieldVisibility();
                });
            }
        }

        function isIdentityField(field) {
            if (!field) return false;
            if (field.fieldId && FIELD_DICTIONARY[field.fieldId]) {
                return FIELD_DICTIONARY[field.fieldId].category === 'Identity';
            }
            const match = Object.values(FIELD_DICTIONARY).find(def => def.key === field.key);
            return match ? match.category === 'Identity' : false;
        }

        function enforceIdentityFieldVisibility({ skipRender = false } = {}) {
            const control = document.getElementById('identityToggleControl');
            const hint = document.getElementById('identityToggleHint');

            if (control) {
                control.classList.toggle('active', state.showIdentityFields);
            }

            if (hint) {
                hint.textContent = state.showIdentityFields
                    ? 'Include preferred name, pronouns, and gender identity.'
                    : 'Hidden (not included in QR).';
            }

            if (state.showIdentityFields) {
                if (state.hiddenIdentityFields.length > 0) {
                    const merged = [...state.fields];
                    state.hiddenIdentityFields
                        .sort((a, b) => a.index - b.index)
                        .forEach(({ field, index }) => {
                            const insertIndex = Math.min(index, merged.length);
                            merged.splice(insertIndex, 0, field);
                        });
                    state.fields = merged;
                    state.hiddenIdentityFields = [];
                }

                const identityFieldIds = [403, 401, 402];
                identityFieldIds.forEach(fieldId => {
                    const fieldDef = FIELD_DICTIONARY[fieldId];
                    if (!fieldDef) return;

                    const alreadyPresent = state.fields.some(field =>
                        field.fieldId === fieldId || field.key === fieldDef.key
                    );

                    if (!alreadyPresent) {
                        addFieldById(fieldId);
                    }
                });
            } else {
                const identityEntries = [];
                const remaining = [];

                state.fields.forEach((field, index) => {
                    if (isIdentityField(field)) {
                        identityEntries.push({ field, index });
                    } else {
                        remaining.push(field);
                    }
                });

                if (identityEntries.length > 0) {
                    state.hiddenIdentityFields = identityEntries;
                    state.fields = remaining;
                }
            }

            if (!skipRender) {
                renderFields();
            }
        }

        function setHeroDefault() {
            const hero = document.getElementById('hero');
            const heroTitle = document.getElementById('heroTitle');
            const heroSubtitle = document.getElementById('heroSubtitle');
            const heroFields = document.getElementById('heroFields');

            if (!hero || !heroTitle || !heroSubtitle || !heroFields) return;

            hero.classList.remove('has-data');
            heroTitle.textContent = 'Scan a QR to view shared details';
            heroSubtitle.textContent = "Use the camera scanner below or open a QR link to instantly load someone's saved information.";
            heroFields.innerHTML = '';
            heroFields.classList.add('hidden');
        }

        function updateHeroWithFields(fields) {
            const hero = document.getElementById('hero');
            const heroTitle = document.getElementById('heroTitle');
            const heroSubtitle = document.getElementById('heroSubtitle');
            const heroFields = document.getElementById('heroFields');

            if (!hero || !heroTitle || !heroSubtitle || !heroFields) return;

            hero.classList.add('has-data');
            heroTitle.textContent = 'Shared QR details';
            heroSubtitle.textContent = 'Here‚Äôs what this QR wants you to know:';

            const fieldsHtml = fields.map(field => `
                <div class="hero-field">
                    <div class="hero-field-label">
                        <span>${field.icon || 'üìù'}</span>
                        <span>${field.label}</span>
                    </div>
                    <div class="hero-field-value">${getFieldValueHtml(field)}</div>
                </div>
            `).join('');

            heroFields.innerHTML = fieldsHtml;
            heroFields.classList.remove('hidden');

            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function updateProgress() {
            document.querySelectorAll('.progress-step').forEach(step => {
                const stepNum = parseInt(step.dataset.step);
                step.classList.remove('active', 'complete');
                if (stepNum < state.currentStep) {
                    step.classList.add('complete');
                } else if (stepNum === state.currentStep) {
                    step.classList.add('active');
                }
            });
        }

        function selectTemplate(templateKey) {
            state.selectedTemplate = templateKey;
            state.currentStep = Math.max(state.currentStep, 2);
            document.querySelectorAll('.template-card').forEach(c => {
                c.classList.toggle('selected', c.dataset.template === templateKey);
            });
            loadDefaultTemplate();
            updateProgress();
        }

        function selectTheme(themeKey) {
            state.selectedTheme = themeKey;
            state.currentStep = Math.max(state.currentStep, 5);
            document.querySelectorAll('.theme-option').forEach(o => {
                o.classList.toggle('selected', o.dataset.theme === themeKey);
            });

            Object.values(THEMES).forEach(theme => {
                document.body.classList.remove(theme.class);
            });
            document.body.classList.add(THEMES[themeKey].class);
            updateProgress();
        }

        function loadDefaultTemplate() {
            const template = TEMPLATES[state.selectedTemplate];
            state.fields = [];
            template.defaultFields.forEach(fieldId => addFieldById(fieldId));
            renderFields();
        }

        function showFieldPicker() {
            const modal = document.getElementById('fieldPickerModal');
            const list = document.getElementById('fieldPickerList');
            list.innerHTML = '';
            
            const categories = {};
            Object.entries(FIELD_DICTIONARY).forEach(([id, field]) => {
                if (field.category === 'Identity' && !state.showIdentityFields) return;
                if (!categories[field.category]) categories[field.category] = [];
                categories[field.category].push({ id: parseInt(id), ...field });
            });
            
            Object.entries(categories).forEach(([category, fields]) => {
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'field-picker-category';
                categoryDiv.innerHTML = `<h4>${category}</h4>`;
                list.appendChild(categoryDiv);
                
                fields.forEach(field => {
                    const item = document.createElement('div');
                    item.className = 'field-picker-item';
                    item.innerHTML = `
                        <span class="field-icon">${field.icon}</span>
                        <span>${field.label}</span>
                    `;
                    item.addEventListener('click', () => {
                        addFieldById(field.id);
                        renderFields();
                        closeFieldPicker();
                    });
                    list.appendChild(item);
                });
            });
            
            // Identity reminder
            if (!state.showIdentityFields) {
                const reminder = document.createElement('div');
                reminder.className = 'info-banner';
                reminder.style.marginTop = '24px';
                reminder.innerHTML = `
                    <div class="info-banner-icon">‚ÑπÔ∏è</div>
                    <div class="info-banner-content">
                        <strong>Identity fields are hidden.</strong> Toggle "Identity fields" above to add preferred name, pronouns, and gender identity fields.
                    </div>
                `;
                list.appendChild(reminder);
            }
            
            modal.classList.add('active');
        }

        function closeFieldPicker() {
            document.getElementById('fieldPickerModal').classList.remove('active');
        }

        function addFieldById(fieldId, protected = false) {
            const fieldDef = FIELD_DICTIONARY[fieldId];
            if (!fieldDef) return;
            
            const field = {
                id: state.nextFieldId++,
                fieldId: fieldId,
                label: fieldDef.label,
                key: fieldDef.key,
                type: fieldDef.type,
                icon: fieldDef.icon,
                value: '',
                protected: protected
            };
            
            if (fieldDef.options) field.options = fieldDef.options;
            if (fieldDef.type === 'medication') field.medications = [];
            
            state.fields.push(field);
            state.currentStep = Math.max(state.currentStep, 3);
            updateProgress();
        }

        function renderFields() {
            const container = document.getElementById('fieldList');
            container.innerHTML = '';

            if (state.fields.length === 0) {
                container.innerHTML = `<p style="text-align: center; color: var(--text-medium); padding: 40px 20px;">No fields yet. Add information fields using the button below.</p>`;
                return;
            }

            state.fields.forEach(field => {
                const fieldItem = document.createElement('div');
                fieldItem.className = 'field-item';
                
                let inputHTML = '';
                
                if (field.type === 'select') {
                    inputHTML = `
                        <select data-field-id="${field.id}">
                            <option value="">Select ${field.label}</option>
                            ${field.options.map(opt => 
                                `<option value="${opt}" ${field.value === opt ? 'selected' : ''}>${opt}</option>`
                            ).join('')}
                        </select>
                    `;
                } else if (field.type === 'medication') {
                    inputHTML = `
                        <input type="text" 
                               data-field-id="${field.id}" 
                               placeholder="Search for medication...">
                        <div id="med-list-${field.id}" style="margin-top: 12px;"></div>
                    `;
                } else {
                    inputHTML = `
                        <input type="${field.type}" 
                               data-field-id="${field.id}" 
                               value="${field.value}" 
                               placeholder="Enter ${field.label.toLowerCase()}">
                    `;
                }
                
                fieldItem.innerHTML = `
                    <div class="field-header">
                        <div class="field-label">
                            <span class="field-icon">${field.icon}</span>
                            <span>${field.label}</span>
                        </div>
                        <div class="field-actions">
                            <button class="btn btn-danger btn-small" data-field-id="${field.id}">Remove</button>
                        </div>
                    </div>
                    ${inputHTML}
                    <div class="privacy-toggle">
                        <input type="checkbox" data-field-id="${field.id}" data-protected="true" 
                               ${field.protected ? 'checked' : ''} id="protect-${field.id}">
                        <label for="protect-${field.id}">üîí Password protect this field</label>
                    </div>
                `;

                container.appendChild(fieldItem);
            });

            // Attach event listeners
            container.querySelectorAll('input[data-field-id], select[data-field-id]').forEach(input => {
                if (input.dataset.protected === 'true') {
                    input.addEventListener('change', (e) => {
                        const field = state.fields.find(f => f.id == e.target.dataset.fieldId);
                        if (!field) return;
                        
                        if (e.target.checked) {
                            if (!state.protectionPassword) {
                                e.target.checked = false;
                                showPasswordModal(field.id);
                            } else {
                                field.protected = true;
                                state.hasProtectedFields = true;
                            }
                        } else {
                            field.protected = false;
                            state.hasProtectedFields = state.fields.some(f => f.protected);
                            if (!state.hasProtectedFields) state.protectionPassword = null;
                        }
                    });
                } else {
                    input.addEventListener('input', (e) => {
                        const field = state.fields.find(f => f.id == e.target.dataset.fieldId);
                        if (field) field.value = e.target.value;
                    });
                }
            });

            container.querySelectorAll('.btn-danger').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const fieldId = parseInt(e.target.dataset.fieldId);
                    state.fields = state.fields.filter(f => f.id !== fieldId);
                    renderFields();
                });
            });
        }

        // Password Modal Functions
        let pendingProtectionFieldId = null;

        function showPasswordModal(fieldId) {
            pendingProtectionFieldId = fieldId;
            document.getElementById('passwordModal').classList.add('active');
            document.getElementById('passwordInput').value = '';
            document.getElementById('passwordConfirm').value = '';
            document.getElementById('passwordStrength').innerHTML = '';
            document.getElementById('passwordInput').focus();
        }

        function closePasswordModal() {
            document.getElementById('passwordModal').classList.remove('active');
            pendingProtectionFieldId = null;
        }

        window.closePasswordModal = closePasswordModal;
        window.closeFieldPicker = closeFieldPicker;

        function checkPasswordStrength(password) {
            let strength = 0;
            let feedback = [];
            
            if (password.length >= 8) strength++;
            else feedback.push('at least 8 characters');
            if (password.length >= 12) strength++;
            if (/[a-z]/.test(password)) strength++;
            else feedback.push('lowercase letters');
            if (/[A-Z]/.test(password)) strength++;
            else feedback.push('uppercase letters');
            if (/[0-9]/.test(password)) strength++;
            else feedback.push('numbers');
            if (/[^a-zA-Z0-9]/.test(password)) strength++;
            else feedback.push('special characters');
            
            return { strength, feedback };
        }

        function updatePasswordStrength() {
            const password = document.getElementById('passwordInput').value;
            const confirm = document.getElementById('passwordConfirm').value;
            const strengthDiv = document.getElementById('passwordStrength');
            
            if (password.length === 0) {
                strengthDiv.innerHTML = '';
                return;
            }
            
            const { strength, feedback } = checkPasswordStrength(password);
            
            let color, text, bgColor;
            if (strength < 3) {
                color = '#E74C3C';
                bgColor = '#FFEBEE';
                text = '‚ùå Weak - Not secure enough';
            } else if (strength < 5) {
                color = '#F39C12';
                bgColor = '#FFF3E0';
                text = '‚ö†Ô∏è Medium - Could be stronger';
            } else {
                color = '#27AE60';
                bgColor = '#E8F5E9';
                text = '‚úì Strong - Good password';
            }
            
            let html = `
                <div style="padding: 12px; background: ${bgColor}; border-radius: 8px; border: 2px solid ${color}; margin-bottom: 16px;">
                    <div style="color: ${color}; font-weight: 600; margin-bottom: 8px;">${text}</div>
            `;
            
            if (feedback.length > 0 && strength < 5) {
                html += `<div style="font-size: 0.85rem; color: var(--text-medium);">Add: ${feedback.join(', ')}</div>`;
            }
            
            if (confirm.length > 0) {
                if (password === confirm) {
                    html += `<div style="color: #27AE60; font-size: 0.85rem; margin-top: 4px;">‚úì Passwords match</div>`;
                } else {
                    html += `<div style="color: #E74C3C; font-size: 0.85rem; margin-top: 4px;">‚úó Passwords don't match</div>`;
                }
            }
            
            html += '</div>';
            strengthDiv.innerHTML = html;
        }

        function validateAndSetPassword() {
            const password = document.getElementById('passwordInput').value;
            const confirm = document.getElementById('passwordConfirm').value;
            
            if (!password) {
                alert('Please enter a password.');
                return;
            }
            
            if (password !== confirm) {
                alert('Passwords do not match.');
                return;
            }
            
            const { strength } = checkPasswordStrength(password);
            
            if (strength < 4) {
                const proceed = confirm(
                    'Your password is not very strong. A strong password should have:\n' +
                    '‚Ä¢ At least 8 characters (12+ recommended)\n' +
                    '‚Ä¢ Uppercase and lowercase letters\n' +
                    '‚Ä¢ Numbers and special characters\n\n' +
                    'Use this password anyway?'
                );
                if (!proceed) return;
            }
            
            state.protectionPassword = password;
            state.hasProtectedFields = true;
            
            if (pendingProtectionFieldId) {
                const field = state.fields.find(f => f.id === pendingProtectionFieldId);
                if (field) field.protected = true;
            }
            
            closePasswordModal();
            renderFields();
            
            // Success notification
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 80px;
                right: 24px;
                background: #E8F5E9;
                color: #27AE60;
                padding: 16px 24px;
                border-radius: 12px;
                border: 2px solid #27AE60;
                font-weight: 600;
                z-index: 10001;
                box-shadow: var(--shadow-lg);
            `;
            notification.textContent = '‚úì Password set successfully';
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.transition = 'opacity 0.3s';
                notification.style.opacity = '0';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        async function generateQR() {
            if (state.fields.length === 0) {
                alert('Please add at least one field.');
                return;
            }

            state.currentStep = 5;
            updateProgress();

            const publicFields = state.fields.filter(f => !f.protected && (f.value || f.medications?.length > 0));
            const protectedFields = state.fields.filter(f => f.protected && (f.value || f.medications?.length > 0));

            let data;

            if (state.compressed) {
                data = {
                    v: 1,
                    t: Object.keys(TEMPLATES).indexOf(state.selectedTemplate),
                    th: Object.keys(THEMES).indexOf(state.selectedTheme),
                    f: publicFields.map(f => {
                        if (f.medications) return [f.fieldId || f.key, f.medications];
                        return [f.fieldId || f.key, f.value];
                    })
                };

                if (protectedFields.length > 0) {
                    if (!state.protectionPassword) {
                        alert('Error: Password not set for protected fields.');
                        return;
                    }
                    const encryptedData = await encryptFields(protectedFields, state.protectionPassword);
                    data.enc = encryptedData;
                }
            } else {
                if (protectedFields.length > 0) {
                    alert('Simple Code mode cannot include password-protected fields. Please remove protection or switch to Smart Code.');
                    return;
                }

                const lines = [];
                lines.push('Personal QR Code Information');
                lines.push('-----------------------------');
                publicFields.forEach(field => {
                    const value = formatPlainTextValue(field);
                    if (!value) return;
                    if (value.includes('\n')) {
                        lines.push(`${field.label}:`);
                        value.split('\n').forEach(line => {
                            lines.push(`  ${line}`);
                        });
                    } else {
                        lines.push(`${field.label}: ${value}`);
                    }
                });

                const plainText = lines.join('\n');
                displayQRCode(plainText, plainText.length, false);
                return;
            }

            const jsonString = JSON.stringify(data);
            const encoded = btoa(jsonString);
            const url = `${window.location.origin}${window.location.pathname}#${encoded}`;

            displayQRCode(url, jsonString.length, true);
        }

        async function encryptFields(fields, password) {
            const data = JSON.stringify(fields.map(f => [f.fieldId || f.key, f.medications || f.value]));
            const enc = new TextEncoder();
            const keyMaterial = await crypto.subtle.importKey("raw", enc.encode(password), "PBKDF2", false, ["deriveKey"]);
            const key = await crypto.subtle.deriveKey(
                { name: "PBKDF2", salt: enc.encode("qr-salt-v1"), iterations: 100000, hash: "SHA-256" },
                keyMaterial,
                { name: "AES-GCM", length: 256 },
                false,
                ["encrypt"]
            );
            const iv = crypto.getRandomValues(new Uint8Array(12));
            const encrypted = await crypto.subtle.encrypt({ name: "AES-GCM", iv: iv }, key, enc.encode(data));
            const combined = new Uint8Array(iv.length + encrypted.byteLength);
            combined.set(iv, 0);
            combined.set(new Uint8Array(encrypted), iv.length);
            return btoa(String.fromCharCode(...combined));
        }

        function displayQRCode(content, dataSize, isUrl = true) {
            const output = document.getElementById('qrOutput');
            const qrcodeDiv = document.getElementById('qrcode');
            qrcodeDiv.innerHTML = '';

            new QRCode(qrcodeDiv, {
                text: content,
                width: 300,
                height: 300,
                colorDark: "#000000",
                colorLight: "#ffffff",
                correctLevel: QRCode.CorrectLevel.M
            });

            const dataSizeElement = document.getElementById('dataSize');
            if (isUrl) {
                dataSizeElement.textContent = `Data size: ${dataSize} bytes (requires this website to view full details)`;
            } else {
                dataSizeElement.textContent = `Data size: ${dataSize} characters (plain text readable in any QR scanner)`;
            }
            output.classList.remove('hidden');
            output.scrollIntoView({ behavior: 'smooth' });
            window.currentQRContent = content;
        }

        function formatPlainTextValue(field) {
            if (field.medications && field.medications.length > 0) {
                return field.medications.map(med => {
                    const parts = [];
                    if (med.brand || med.generic) parts.push(med.brand || med.generic);
                    if (med.dosage) parts.push(`Dosage: ${med.dosage}`);
                    if (med.frequency) parts.push(`Frequency: ${med.frequency}`);
                    return `- ${parts.join(' | ')}`;
                }).join('\n');
            }

            if (!field.value) return '';

            if (Array.isArray(field.value)) {
                return field.value.join(', ');
            }

            return field.value;
        }

        function downloadQR() {
            const canvas = document.querySelector('#qrcode canvas');
            if (!canvas) return;
            const url = canvas.toDataURL('image/png');
            const link = document.createElement('a');
            link.download = 'qr-code.png';
            link.href = url;
            link.click();
        }

        function checkURLForData() {
            const hash = window.location.hash.substring(1);
            if (!hash) return;

            try {
                const decoded = atob(hash);
                const data = JSON.parse(decoded);
                document.querySelector('[data-mode="view"]').click();
                displayDecodedData(data);
            } catch (e) {
                console.error('Error decoding:', e);
            }
        }

        function getFieldValueHtml(field) {
            if (Array.isArray(field.value)) {
                return field.value.map(med =>
                    `<div style="margin-bottom: 8px; padding: 12px; background: var(--bg-secondary); border-radius: 8px;">
                        <strong>${med.brand || med.generic}</strong><br>
                        ${med.dosage ? `<span style='color: var(--text-medium);'>Dosage: ${med.dosage}</span><br>` : ''}
                        ${med.frequency ? `<span style='color: var(--text-medium);'>Frequency: ${med.frequency}</span>` : ''}
                    </div>`
                ).join('');
            }
            return formatFieldValue(field);
        }

        function displayDecodedData(data) {
            const container = document.getElementById('decodedData');
            container.innerHTML = '';

            const isCompressed = data.v !== undefined;
            let fields;

            if (isCompressed) {
                fields = data.f.map(([fieldId, value]) => {
                    const fieldDef = typeof fieldId === 'number' ? FIELD_DICTIONARY[fieldId] : null;
                    return {
                        key: fieldDef ? fieldDef.key : fieldId,
                        label: fieldDef ? fieldDef.label : fieldId,
                        icon: fieldDef ? fieldDef.icon : 'üìù',
                        value: value,
                        type: fieldDef ? fieldDef.type : 'text'
                    };
                });
            } else {
                fields = data.fields;
            }

            updateHeroWithFields(fields);

            container.innerHTML = `
                <div class="decoded-cta">
                    <h3>Make your own QR</h3>
                    <p>Keep important details at the ready. Use the builder below to create a personalized QR with your information.</p>
                    <a class="btn btn-outline" href="#createMode">Make a QR</a>
                </div>
            `;
        }

        function formatFieldValue(field) {
            if (field.type === 'url') return `<a href="${field.value}" target="_blank" style="color: var(--primary);">${field.value}</a>`;
            if (field.type === 'email') return `<a href="mailto:${field.value}" style="color: var(--primary);">${field.value}</a>`;
            if (field.type === 'tel') return `<a href="tel:${field.value}" style="color: var(--primary);">${field.value}</a>`;
            return field.value;
        }

        // QR Scanner (simplified for brevity)
        let stream = null;
        let scanning = false;

        async function startScanner() {
            const video = document.getElementById('videoElement');
            const btn = document.getElementById('startScanBtn');
            
            if (scanning) {
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                    stream = null;
                }
                video.style.display = 'none';
                scanning = false;
                btn.innerHTML = '<span>üì∑</span> Start Camera Scanner';
                return;
            }
            
            try {
                stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                video.srcObject = stream;
                video.style.display = 'block';
                video.play();
                scanning = true;
                btn.innerHTML = '<span>‚è∏Ô∏è</span> Stop Scanner';
            } catch (error) {
                alert('Camera access denied or not available.');
                console.error(error);
            }
        }
    </script>
</body>
</html>
